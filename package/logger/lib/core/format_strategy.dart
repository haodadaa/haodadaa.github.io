import 'dart:convert';
import 'dart:isolate';

import '../logger.dart';
import '../support/ansi_color.dart';
import 'log_strategy.dart';
// import 'package:stack_trace/stack_trace.dart';

abstract class FormatStrategy {
  const FormatStrategy();

  void log(
    LogLevel level,
    String? tag,
    dynamic message,
    dynamic error,
    StackTrace? stackTrace,
  );
}

class DefaultFormatStrategy extends FormatStrategy {
  static const int CHUNK_SIZE = 4000;

  static const int MIN_STACK_OFFSET = 5;

  static const String _TOP_LEFT_CORNER = '┌';
  static const String _BOTTOM_LEFT_CORNER = '└';
  static const String _MIDDLE_CORNER = '├';
  static const String _HORIZONTAL_LINE = '│';
  static const String _DOUBLE_DIVIDER =
      "────────────────────────────────────────────────────────";
  static const String _SINGLE_DIVIDER =
      "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄";
  static const String _TOP_BORDER =
      _TOP_LEFT_CORNER + _DOUBLE_DIVIDER + _DOUBLE_DIVIDER;
  static const String _BOTTOM_BORDER =
      _BOTTOM_LEFT_CORNER + _DOUBLE_DIVIDER + _DOUBLE_DIVIDER;
  static const String _MIDDLE_BORDER =
      _MIDDLE_CORNER + _SINGLE_DIVIDER + _SINGLE_DIVIDER;

  static final Map<LogLevel, AnsiColor> _levelColors = {
    LogLevel.verbose: AnsiColor()..gray(level: 0.5),
    LogLevel.debug: AnsiColor(),
    LogLevel.info: AnsiColor()..green(bold: true),
    LogLevel.warning: AnsiColor()..rgb(r: 1, g: 0.4, b: 0),
    LogLevel.error: AnsiColor()..rgb(r: 1, g: 0, b: 0),
  };

  /// Matches a stacktrace line as generated on Android/iOS devices.
  /// For example:
  /// #1      Logger.log (package:logger/src/logger.dart:115:29)
  static final _deviceStackTraceRegex =
      RegExp(r'#[0-9]+[\s]+(.+) \(([^\s]+)\)');

  /// Matches a stacktrace line as generated by Flutter web.
  /// For example:
  /// packages/logger/src/printers/pretty_printer.dart 91:37
  static final _webStackTraceRegex =
      RegExp(r'^((packages|dart-sdk)\/[^\s]+\/)');

  /// Matches a stacktrace line as generated by browser Dart.
  /// For example:
  /// dart:sdk_internal
  /// package:logger/src/logger.dart
  static final _browserStackTraceRegex =
      RegExp(r'^(?:package:)?(dart:[^\s]+|[^\s]+)');

  final int? errorMethodCount;
  final int methodOffset;
  final bool showThreadInfo;
  final LogStrategy logStrategy;

  const DefaultFormatStrategy({
    this.errorMethodCount,
    this.methodOffset = 0,
    this.showThreadInfo = false,
    this.logStrategy = const PrintLogStrategy(),
  }) : super();

  @override
  void log(
    LogLevel level,
    String? logTag,
    dynamic message,
    dynamic error,
    StackTrace? stackTrace,
  ) {
    String? tag = _formatTag(logTag);

    String messageStr = _formatMessage(message);

    String result = '';
    result = _addTopBorder(result);

    /// Tag
    if (tag != null) {
      result = _addContent(result, tag);
      result = _addDivider(result);
    }

    Isolate.current;
    // /// current StackTrace
    // result = _addContent(
    //     result, _formatStackTrace(StackTrace.current, methodCount) ?? '');
    // result = _addDivider(result);

    /// error
    if (error != null) {
      result = _addContent(result, error.toString());
      result = _addDivider(result);
    }

    /// error StackTrace
    if (stackTrace != null) {
      result = _addContent(
        result,
        _formatStackTrace(stackTrace, errorMethodCount) ??
            'Parser StackTrace Failed',
      );
      result = _addDivider(result);
    }

    /// message
    result = _addContent(result, messageStr);
    result = _addBottomBorder(result);

    /// 将完整字符串分割成多行分别打印
    List<String> lines = result.split('\n');
    logStrategy.log(lines.map<String>((e) => _levelColors[level]!(e)).toList());
  }

  String? _formatTag(String? logTag) {
    if (logTag == null || logTag.isEmpty) {
      return null;
    }
    return logTag;
  }

  String _formatMessage(dynamic message) {
    if (message is Map || message is Iterable) {
      var encoder = JsonEncoder.withIndent('  ', _toEncodeFallback);
      return encoder.convert(message);
    } else {
      return message.toString();
    }
  }

  Object _toEncodeFallback(dynamic object) {
    return object.toString();
  }

  String _addTopBorder(String content) {
    return content + _TOP_BORDER + '\n';
  }

  String _addDivider(String content) {
    return content + _MIDDLE_BORDER + '\n';
  }

  String _addBottomBorder(String content) {
    return content + _BOTTOM_BORDER;
  }

  String _addContent(String content, String message) {
    final pattern = RegExp('.{1,1024}');
    for (RegExpMatch match in pattern.allMatches(message)) {
      content =
          content + _HORIZONTAL_LINE + ' ' + (match.group(0) ?? '') + '\n';
    }
    return content;
  }

  String? _formatStackTrace(StackTrace stackTrace, int? methodCount) {
    var lines = stackTrace.toString().split('\n');
    var formatted = <String>[];
    var count = 0;
    for (var line in lines) {
      if (_discardDeviceStacktraceLine(line) ||
          _discardWebStacktraceLine(line) ||
          _discardBrowserStacktraceLine(line) ||
          line.isEmpty) {
        continue;
      }
      formatted.add('#$count   ${line.replaceFirst(RegExp(r'#\d+\s+'), '')}');
      count++;
      if (methodCount != null && count == methodCount) {
        break;
      }
    }

    if (formatted.isEmpty) {
      return null;
    } else {
      return formatted.join('\n');
    }
  }

  bool _discardDeviceStacktraceLine(String line) {
    var match = _deviceStackTraceRegex.matchAsPrefix(line);
    if (match == null) {
      return false;
    }
    return match.group(2)!.startsWith('package:logger');
  }

  bool _discardWebStacktraceLine(String line) {
    var match = _webStackTraceRegex.matchAsPrefix(line);
    if (match == null) {
      return false;
    }
    return match.group(1)!.startsWith('packages/logger') ||
        match.group(1)!.startsWith('dart-sdk/lib');
  }

  bool _discardBrowserStacktraceLine(String line) {
    var match = _browserStackTraceRegex.matchAsPrefix(line);
    if (match == null) {
      return false;
    }
    return match.group(1)!.startsWith('package:logger') ||
        match.group(1)!.startsWith('dart:');
  }
}
